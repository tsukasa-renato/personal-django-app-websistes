{% load static %}
{% load filters %}


<form method="post" action="{% url 'websites:cart' url=website.url %}" id="options_form">
    {% csrf_token %}

    <input type="hidden" name="product" value="{{ product.pk }}" />

    <div class="row mt-5">

        <div class="col-sm text-center" id="product_image">
            {% if product.images %}
                <img class="card-img-top" src="{{ product.images.url }}" alt="{{ product.images.name }}"
                 style="max-height:400px;max-width:100%;">
            {% else %}
            <img src="{% static 'media/category.png' %}" alt="{{ product.title }}"
                 style="max-height:400px;max-width:100%;">
            {% endif %}
        </div>

        <div class="col-sm text-center">

            <h5 id="product_title">
                {{ product.title }}
            </h5>

            <p class="overflow-auto" style="max-height:300px;" id="product_description">
                {% if product.description %}
                    {{ product.description|safe }}
                {% endif %}
            </p>

        </div>

    </div>

    <div class="row justify-content-center">
        <img src="{% static 'media/line.jpg' %}" style="max-width:100%;">
    </div>

    {% for group in groups %}
    <div class="row mt-5">

        <div class="col-sm text-center" id="{{ group }}_image">
            <!-- Option title selected -->
        </div>

        <div class="col-sm text-center">

            <h5 id="{{ group }}_title">
                <!-- Option title selected -->
            </h5>

            <p class="overflow-auto" style="max-height:300px;" id="{{ group }}_description">
                <!-- Option description selected -->
            </p>

        </div>

    </div>

    <div class="row justify-content-center">
        <h4 id="{{ group }}"> {{ group.title }} </h4>
    </div>

    <div class="row justify-content-center" id="{{ group }}_options">
        <!-- Options -->
    </div>

    <div class="row justify-content-center">
        <img src="{% static 'media/line.jpg' %}" style='max-width:100%;'>
    </div>

    {% endfor %}

    <div class='row navbar mt-3'>
        <div class='col text-center text'>
            <h5 id="product_total">
                <!-- Total -->
            </h5>
            <button type='submit' class='btn btn-success'>
                <b> + </b> Add to Cart
            </button>
        </div>
    </div>



</form>

<script>
    $(document).ready(function(){

        currency = new Intl.NumberFormat('{{ website.language|html_format }}', {
                                            style: 'currency', currency: '{{ website.currency }}' })

        {% if product.get_real_price %}
            total = {{ product.get_real_price }}
        {% else %}
            total = 0
        {% endif %}

        {% for group in groups %}
            {{ group }}_selected_option = 0
            {{ group }}_total = 0
        {% endfor %}

        {% for option in options %}

            options_group = $("#{{ option.groups }}_options");

            /*The get_real_price method checks if the option is in the promotion and returns the promotional_price
            else it returns normal price else returns None.*/

            {% if option.get_real_price %}
                content = "{% money_format option.get_real_price website.currency website.language %}";
            {% else %}
                content = "{{ option.title }}";
            {% endif %}

            /*Creating an icon rounded for the option.*/
            {% if option.images %}
                image = "<img src='{{ option.images.url }}' class='rounded-circle mr-1' " +
                        "alt='{{ option }}' style='width: 30px;height: 30px;'>";
            {% else %}
                image = ""
            {% endif %}

            /*Used for number type input and to check whether the input is read-only.*/

            min = {{ option.minimum }}
            max = {{ option.maximum }}

            /*In radio type input, the name is the same for the options that group.*/

            input_type = "{{ option.check_input_type }}";

            if (input_type == "radio") {

                name = "{{ option.groups }}";

            } else {

                name = "{{ option.pk }}"

                if (input_type == "number") {

                    quantity{{ option.pk }} = min
                    option_total{{ option.pk }} = {{ option.get_real_price }} * quantity{{ option.pk }}

                }
            }

            html_input = returns_html_input(input_type, name, "{{ option.pk }}", min, max, image, content);

            options_group.append(function() {

                return  html_input;

            });

            $("#{{ option.pk }}").click(function(){

                image = ""
                desc = ""

                {% if option.images %}
                    image = "{{ option.images.url }}"
                {% endif %}

                {% if option.description %}
                    desc = "{{ option.description }}"
                {% endif %}

                change_option_info("{{ option.groups }}", "{{ option.title }}", desc, image);

                {% if option.minimum == option.maximum %}

                    $(this).prop('checked', true);

                {% else %}

                {% if option.get_real_price %}

                    total -= {{ option.groups }}_total

                    if ($(this).is(':radio')) {

                        {{ option.groups }}_selected_option = 1
                        {{ option.groups }}_total = {{ option.get_real_price }}

                    } else if ($(this).is(':checkbox')) {

                        if ($(this).is(":checked")) {

                            {{ option.groups }}_selected_option += 1
                            {{ option.groups }}_total += {{ option.get_real_price }};

                        } else {

                            {{ option.groups }}_selected_option -= 1
                            {{ option.groups }}_total -= {{ option.get_real_price }};

                        }

                    } else {

                        {{ option.groups }}_selected_option -= quantity{{ option.pk }}
                        {{ option.groups }}_total -= option_total{{ option.pk }}

                        quantity{{ option.pk }} = parseInt($(this).val())
                        option_total{{ option.pk }} = {{ option.get_real_price }} * quantity{{ option.pk }}

                        {{ option.groups }}_selected_option += quantity{{ option.pk }}
                        {{ option.groups }}_total += option_total{{ option.pk }}

                    }

                    {% if option.groups.type_price == '2' %}
                        {{ option.groups }}_total /= {{ option.groups }}_selected_option
                    {% endif %}

                    total += {{ option.groups }}_total

                    $("#product_total").text(currency.format(total));

                {% endif %}

                {% endif %}

                console.log(currency.format(total));

            });

            {{ option.groups }}_selected_option += min;

            {% if option.get_real_price %}
                total += min * {{ option.get_real_price }}
            {% endif %}

        {% endfor %}

        $("#product_total").text(currency.format(total));

        $("#options_form").submit(function(e) {

            {% for group in groups %}

                if (( {{ group.maximum }} < number_elements{{ group.pk }} ) || ({{ group.minimum }} > number_elements{{ group.pk }})) {
                    $("#{{ group.slug }}_options").focus();
                    e.preventDefault();
                }

            {% endfor %}

        });

    });
</script>