{% load static %}
{% load filters %}


<form method="post" action="{% url 'websites:cart' url=website.url %}" id="options_form">
    {% csrf_token %}

    <div class="row mt-5">

        <div class="col-sm text-center" id="product_image">
            {% if product.images %}
                <img class="card-img-top" src="{{ product.images.url }}" alt="{{ product.images.name }}"
                 style="max-height:400px;max-width:100%;">
            {% else %}
            <img src="{% static 'media/category.png' %}" alt="{{ product.title }}"
                 style="max-height:400px;max-width:100%;">
            {% endif %}
        </div>

        <div class="col-sm text-center">

            <h5 id="product_title">
                {{ product.title }}
            </h5>

            <p class="overflow-auto" style="max-height:300px;" id="product_description">
                {{ product.description|safe }}
            </p>

        </div>

    </div>

    <div class="row justify-content-center">
        <img src="{% static 'media/line.jpg' %}" style="max-width:100%;">
    </div>

    {% for group in groups %}
    <div class="row mt-5">

        <div class="col-sm text-center" id="{{ group.slug }}_images">
            <!-- Option title selected -->
        </div>

        <div class="col-sm text-center">

            <h5 id="{{ group.slug }}_title">
                <!-- Option title selected -->
            </h5>

            <p class="overflow-auto" style="max-height:300px;" id="{{ group.slug }}_description">
                <!-- Option description selected -->
            </p>

        </div>

    </div>

    <div class="row justify-content-center">
        <h4 id="group_{{ group.slug }}"> {{ group.title }} </h4>
    </div>

    <div class="row justify-content-center"
         {% if group.maximum == 1 and group.minimum == 1 %} name="radio" {% endif %}
         id="{{ group.slug }}_options">
        <!-- Options -->
    </div>

    <div class="row justify-content-center">
        <img src="{% static 'media/line.jpg' %}" style='max-width:100%;'>
    </div>

    {% endfor %}

    <div class='row navbar mt-3'>
        <div class='col text-center text'>
            <h5 id="product_total">
                {% if product.get_real_price %}
                    {% money_format product.get_real_price website.currency website.language %}
                {% else %}
                    {% money_format 0 website.currency website.language %}
                {% endif %}
            </h5>
            <button type='submit' class='btn btn-success'>
                <b> + </b> Add to Cart
            </button>
        </div>
    </div>



</form>

<script>
    $(document).ready(function(){

        currency = new Intl.NumberFormat('{{ website.language|html_format }}', {
                                            style: 'currency', currency: '{{ website.currency }}' })

        {% if product.get_real_price %}
            total = {{ product.get_real_price }}
        {% else %}
            total = 0
        {% endif %}

        {% for group in groups %}
            number_elements{{ group.pk }} = 0
            group_total{{ group.pk }} = 0
        {% endfor %}

        {% for option in options %}

            options_group = $("#{{ option.groups }}_options");


            /*The get_real_price method checks if the option is in the promotion and returns the promotional_price
            else it returns normal price else returns None.*/

            {% if option.get_real_price %}
                content = "{% money_format option.get_real_price website.currency website.language %}";
            {% else %}
                content = "{{ option.title }}";
            {% endif %}

            /*Creating an icon rounded for the options.*/
            {% if option.images %}
                image = "<img src='{{ option.images.url }}' class='rounded-circle mr-1' " +
                        "alt='{{ option.slug }}' style='width: 30px;height: 30px;'>";
            {% else %}
                image = ""
            {% endif %}

            /*Used for number type input and to check whether the input is read-only.*/

            min = {{ option.minimum }}
            max = {{ option.maximum }}

            if (max == min) {
                number_elements{{ option.groups.pk }} += min;
                {% if option.get_real_price %}
                    total += min * {{ option.get_real_price }}
                    $("#product_total").text(currency.format(total));
                {% endif %}
            }

            /*In radio type input, the name is the same for the options that group.*/

            if ((options_group.attr("name") == "radio") && (min==0)) {

                input_type = "radio";
                name = "{{ option.groups }}";

            } else {

                name = "{{ option.pk }}"

                if ({{ option.maximum }} == 1) {

                    input_type = "checkbox";

                } else {

                    input_type = "number";
                    quantity{{ option.pk }} = min
                    option_total{{ option.pk }} = 0

                }

            }

            html_input = returns_input_html(input_type, name, "{{ option.pk }}", min, max, image, content);

            options_group.append(function() {

                return  html_input;

            });

            $("#{{ option.pk }}").click(function(){

                $("#{{ option.groups }}_title").text("{{ option.title }}");
                $("#{{ option.groups }}_description").empty();
                $("#{{ option.groups }}_images").empty();

                {% if option.description %}
                    $("#{{ option.groups }}_description").text("{{ option.description }}");
                {% endif %}

                {% if option.images %}
                $("#{{ option.groups }}_images").html("<img src='{{ option.images.url }}' class='img-fluid' " +
                        "alt='{{ option.slug }}' style='max-height:400px;max-width:100%;'>");
                {% endif %}

                {% if option.get_real_price %}

                    total -= group_total{{ option.groups.pk }}

                    if ($(this).is(':radio')) {

                        group_total{{ option.groups.pk }} = {{ option.get_real_price }}

                    } else if ($(this).is(':checkbox')) {

                        if ($(this).is(":checked")) {

                            number_elements{{ option.groups.pk }} += 1
                            group_total{{ option.groups.pk }} += {{ option.get_real_price }};

                        } else {

                            number_elements{{ option.groups.pk }} -= 1
                            group_total{{ option.groups.pk }} -= {{ option.get_real_price }};

                        }

                        {% if option.groups.type_price == '2' %}
                            group_total{{ option.groups.pk }} /= number_elements{{ option.groups.pk }}
                        {% endif %}

                    } else {

                        number_elements{{ option.groups.pk }} -= quantity{{ option.pk }}
                        group_total{{ option.groups.pk }} -= option_total{{ option.pk }}

                        quantity{{ option.pk }} = $(this).val()
                        option_total{{ option.pk }} = {{ option.get_real_price }} * quantity{{ option.pk }}

                        number_elements{{ option.groups.pk }} += quantity{{ option.pk }}
                        group_total{{ option.groups.pk }} += option_total{{ option.pk }}

                        {% if option.groups.type_price == '2' %}
                            group_total{{ option.groups.pk }} /= number_elements{{ option.groups.pk }}
                        {% endif %}


                    }

                    total += group_total{{ option.groups.pk }}

                    $("#product_total").text(currency.format(total));

                {% endif %}

                console.log(currency.format(total));

            });

        {% endfor %}


    });
</script>